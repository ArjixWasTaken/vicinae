syntax = "proto3";

import "google/protobuf/any.proto";
import "google/protobuf/struct.proto";
import "preference.proto";

package protocols.extensions;

message IpcMessage {
  oneof payload {
    QualifiedExtensionRequest extension_request = 1;
    QualifiedExtensionResponse extension_response = 2;
    QualifiedExtensionEvent extension_event = 3;
    ManagerRequest manager_request = 4;
    ManagerResponse manager_response = 5;
  };
};

message ErrorResponseData {
  string error_text = 1;
};

message ManagerRequestData {
  oneof data {
    ManagerPingRequestData ping = 1;
    ManagerLoadCommand load = 2;
    ManagerUnloadCommand unload = 3;   
  };
};

message ManagerPingRequestData {}

message ManagerRequest {
  string request_id = 1;
  ManagerRequestData payload = 2;
};

message ManagerResponseData {
  oneof data {
    AckResponse ack = 1;
    ManagerLoadResponseData load = 2;
  };
};


message ManagerResponse {
  string request_id = 1;
  oneof result {
    ManagerResponseData value = 2;
    ErrorResponseData error = 3;
  };
};

enum CommandMode {
  View = 0;
  NoView = 1;
};

enum CommandEnv {
  Development = 0;
  Production = 1;
};

message ManagerLoadCommand {
  CommandMode mode = 1;
  CommandEnv env = 2;
  string entrypoint = 3;
  map<string, google.protobuf.Value> preference_values = 4;
  map<string, google.protobuf.Value> argument_values = 5;
};

message ManagerUnloadCommand {
  string session_id = 1;
};

message ManagerLoadResponseData {
  string session_id = 1;
};


message CommandArgument {
  string name = 1;
  string type = 2;
  bool is_required = 3;
  string placeholder = 4;
};

message CommandManifest {
  string id = 1;
  string title = 2;
  string description = 3;
  string mode = 4;
  repeated preference.Preference preferences = 5;
  repeated CommandArgument arguments = 6;
};

message QualifiedExtensionRequest {
  string session_id = 1;
  ExtensionRequest request = 2;
};

message QualifiedExtensionResponse {
  string session_id = 1;
  ExtensionResponse response = 2;
};

message QualifiedExtensionEvent {
  string session_id = 1;
  ExtensionEvent event = 2;
};

message AckResponse {};

message ExtensionResponse {
  string request_id = 1;
  oneof result {
    ExtensionResponseData data = 2;
    ErrorResponseData error = 3;
  };
};

message ExtensionResponseData {
  oneof payload {
    AckResponse ack = 1;
    ListApplicationResponse list_applications = 2;
    ErrorResponseData error = 3;
  };
};

message ExtensionEvent {
  string id = 1;
  repeated google.protobuf.Any args = 2;
};

message ExtensionMessage {
  oneof message {
    ExtensionRequest request = 1;
    ExtensionResponse response = 2;
    ExtensionEvent event = 3;
  };
};

message ExtensionRequest {
  string request_id = 1;
  ExtensionRequestData data = 2;
};

message ExtensionRequestData {
  oneof payload {
    RenderRequest render = 1;
    ListApplicationRequest list_apps = 2;
    OpenApplicationRequest open_apps = 3;
    ShowToastRequest show_toast = 4;
    CopyToClipboardRequest clipboard_copy = 5;
    PushViewRequest push_view = 6;
    PopViewRequest pop_view = 7;
    ClearSearchBarRequest clear_search = 8; 
    CloseMainWindowRequest close_main_window = 9;
    ShowHudRequest show_hud = 10;
  };
};


message Application {
  string id = 1;
  string name = 2;
  string icon = 3;
};

message ShowToastRequest {
  string title = 1;
  string style = 2;
};

message PushViewRequest {}
message PopViewRequest {}
message CloseMainWindowRequest {};
message ClearSearchBarRequest {};

message ShowHudRequest {
  string text = 1;
};

message ClipboardHtmlContent {
  string html = 1;
  string text = 2;
};

message ClipboardPathContent {
  string path = 1;
};

message ClipboardOptions {
  bool concealed = 1;
};

message CopyToClipboardRequest {
  ClipboardOptions options = 1;
  oneof content {
    string text = 2;
    ClipboardHtmlContent html = 3;
    ClipboardPathContent path = 4;
  };
};

message OpenApplicationRequest {
  string target = 1;
  optional string app_id = 2;
};

message ListApplicationRequest {
};

message ListApplicationResponse {
  repeated Application apps = 1;
};


// render stuff

message RenderRequest {
   //repeated RenderNode views = 1;
   // we will migrate to actual protobuf
   string json = 1;
};

message RenderNode {
  string type = 1;
  bool has_dirty_child = 2;
  bool has_dirty_props = 3;
  //map<string, google.protobuf.Any> props = 4;
  repeated RenderNode children = 5;
};


